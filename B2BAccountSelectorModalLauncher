/**
 * Created by Soumyadeep on 02/26/2025.
 */

import { LightningElement } from 'lwc';
import userHasMultipleAccounts from '@salesforce/apex/B2BAccountSelectorController.userHasMultipleAccounts';

import AccountModal from 'c/b2bAccountSelectorModal';
import { genUtil, toastUtil } from 'c/b2bUtil';

export default class B2BAccountSelectorModalLauncher extends LightningElement {

    isBuilderView = false;
    hasUserSelectedAccount = sessionStorage.getItem('userMadeAccountSelection');
    moreThanOneAccount = false;

    // prevents multiple apex calls
    hasCheckedAccounts = false;

    connectedCallback() {
        this.isBuilderView = genUtil.isInSitePreview();
        this.checkCookies();
        this.checkUserHasMultipleAccounts();
    }

    renderedCallback() {
        // renderedCallback fires multiple times, so guard it
        this.checkUserHasMultipleAccounts();
    }

    checkCookies() {
        if (window.OnetrustActiveGroups?.includes('C0003')) {
            sessionStorage.setItem('userMadeAccountSelection', 'true');
        } else {
            toastUtil.toastWarn(this, {
                title: 'Warning',
                message: 'Please enable functional cookies to use the account selector.'
            });
        }
    }

    async checkUserHasMultipleAccounts() {
        if (this.hasCheckedAccounts || this.isBuilderView) {
            return;
        }

        this.hasCheckedAccounts = true;

        try {
            const result = await userHasMultipleAccounts();
            console.log('userHasMultipleAccounts result:', result);

            // Imperative Apex returns value directly
            this.moreThanOneAccount = result;

            this.evaluateModalLaunch();
        } catch (error) {
            console.error('userHasMultipleAccounts error:', error);
        }
    }

    evaluateModalLaunch() {
        console.log('moreThanOneAccount:', this.moreThanOneAccount);
        console.log('hasUserSelectedAccount:', this.hasUserSelectedAccount);

        if (
            this.moreThanOneAccount &&
            this.hasUserSelectedAccount === null &&
            !this.isBuilderView
        ) {
            this.openModal();
        }
    }

    async openModal() {
        await AccountModal.open({
            size: 'medium',
            description: 'Allows you to select a new account to shop for',
            fromWhichParent: 'CustomAccountSelector'
        });
    }
}
