/**
 * @test B2BProductCollectionHandlerTest
 *
 * @description Unit test class for B2BProductCollectionHandler. 
 *  			Validates that collection line item prices are recalculated correctly 
 *
 * Modification Log:
 * Ver   Date         Author        Description
 * 
 */
@IsTest
public class B2BProductCollectionHandlerTest {

    /**
     * @testSetup
     * 
     * @description Creates reusable test data:
     *   			- WebStore, Accounts, Contact, User
     *   			- Product2 with pricing and inventory
     *   			- ProductCollection and a ProductCollectionLineItem
     */
    @testSetup
    static void setupData() {
        WebStore ws = B2B_TestDataFactory.createWebStore();
        
        // Create Accounts
        Account acc1 = B2B_TestDataFactory.createAccount(true);
        Account acc2 = B2B_TestDataFactory.createAccount(false);
        acc2.ST_REGIONAL_FACTOR__c = 20.0;
        acc2.ST_PRICE_FACTOR__c = 20.0;
        acc2.Name = 'testAccount2';
        insert acc2;
        
        // Create Contact + User for community
        Contact c = B2B_TestDataFactory.createContact(acc1);

        // Create Product with pricing & inventory attributes
        Product2 p1 = B2B_TestDataFactory.createProduct2('T-1914970-1','T-1914970-1',false);
        p1.B2B_CHAINED_PARTS__c = 'T-1075764-1,T-1914970-1';
        p1.B2B_FINAL_REPLACED_BY__c = 'T-1914970-1';
        p1.B2B_PRICE__c = 100;
        p1.B2B_LEAD_TIME__c = '50';
        p1.B2B_UNITS__c = 'EA';
        p1.B2B_PACK_QUANTITY__c = 1;
        insert p1;
        List<Product2> products = new List<Product2>();
        products.add(p1);
        
        // Run inventory update + supersession batch
        String msgUUID = B2BMessageQueueUtils.saveInboundMessage(
            'Inventory Update', new Map<String, String> {'a'=>'a'}, 'POST', 
            new Map<String, String>(),  null, Blob.valueOf('Test'), null);
        B2BAPI_InventoryUpdate.InvStatusUpdateResponseWrapper invWrapper = new B2BAPI_InventoryUpdate.InvStatusUpdateResponseWrapper();
        invWrapper.item = 'T-1914970-1';
        invWrapper.inventoryOnHand = '40';
        invWrapper.inventoryAllocated = '6';
        invWrapper.inventoryOnOrder = '0';
        invWrapper.warehouseId = 'UDQS10';
        B2BAPI_InventoryUpdate.updateObjects(invWrapper, msgUUID);
        B2BProductSupersessionBatchable.buildProductSupersessionChain(products);
        
        // Create ProductCollection and LineItem under community user
        ProductCollection__c pc = B2B_TestDataFactory.createProductCollection(ws.Id, acc1.Id);
        ProductCollectionLineItem__c pcItem = B2B_TestDataFactory.createProductCollectionLineItem(p1.Id, pc.Id);
    }

    /**
     * @test testUpdateCollectionItemPricesUpdateAccount
     *
     * @description Validates that prices are recalculated 
     *  			when AccountId__c on ProductCollection__c is changed.
     */
    @IsTest
    static void testUpdateCollectionItemPricesUpdateAccount() {
        
        // Fetch existing collection and clone old version for oldMap
        ProductCollection__c pc = [SELECT Id, AccountId__c FROM ProductCollection__c LIMIT 1];
        ProductCollection__c oldPc = pc.clone(false, true, true, true);

        // Change Account
        Account acc2 = [SELECT Id FROM Account WHERE Name = 'testAccount2' LIMIT 1];
        pc.AccountId__c = acc2.Id;
        ProductCollectionLineItem__c oldli = [
            SELECT Id, B2B_TotalPrice__c 
            FROM ProductCollectionLineItem__c 
            LIMIT 1
        ];

        Test.startTest();
        B2BProductCollectionHandler.updateCollectionItemPrices(
            new List<ProductCollection__c>{ pc },
            new Map<Id, ProductCollection__c>{ oldPc.Id => oldPc }
        );
        Test.stopTest();

        ProductCollectionLineItem__c li = [
            SELECT Id, B2B_TotalPrice__c 
            FROM ProductCollectionLineItem__c 
            LIMIT 1
        ];
        system.debug('oldli.B2B_TotalPrice__c'+oldli.B2B_TotalPrice__c+'li.B2B_TotalPrice__c'+li.B2B_TotalPrice__c);
        Assert.areNotEqual(0, li.B2B_TotalPrice__c,
            'Handler should still update prices when Account changes');
        //Assert.areNotEqual(oldli.B2B_TotalPrice__c, li.B2B_TotalPrice__c,
         //   'As price and Regional Factors are different');
    }

}
