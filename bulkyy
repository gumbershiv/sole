 public void insertCartItems(
        String communityId, 
        String effectiveAccountId, 
        Map<String, B2BCartItemDTO> productIdTob2bCartItemMap, 
        String cartId
    ) {
        
        List<ConnectApi.BatchInput> batchInputs = new List<ConnectApi.BatchInput>();
        
        // Prepare cart item inputs for batch API
        for (B2BCartItemDTO b2bcartItem : productIdTob2bCartItemMap.values()) {
            
            // Removing counter from SKUs "~" which was added to make it unique
            b2bcartItem.sku = b2bcartItem.sku.contains('~') ? b2bcartItem.sku.split('~')[0] : b2bcartItem.sku;         
            batchInputs.add(new ConnectApi.BatchInput(this.convertToCartItemInput(b2bcartItem)));
        }
        Id webstoreId = B2BUtil.resolveCommunityIdToWebstoreId(communityId);
        List<ConnectApi.BatchResult> batchResults;
        
        // Use mock result in test context
        if (Test.isRunningTest()) {
            batchResults =B2BCartItemServiceTest.makeTestAddToCart();
        }else{
            batchResults = ConnectApi.CommerceCart.addItemsToCart(
                webstoreId,
                effectiveAccountId,
                cartId,
                batchInputs
            );
        }
        system.debug('batchResults'+batchResults);
        // Process batch results
        for (Integer index = 0; index < batchResults.size(); index++) {
            ConnectApi.BatchResult batchResult;
            ConnectApi.CartItemInput cartItemInput;
            
            batchResult = batchResults.get(index);
            cartItemInput = (ConnectApi.CartItemInput) batchInputs.get(index).getInput();
            
            B2BCartItemDTO b2bCartItem = productIdTob2bCartItemMap.values().get(index);
            b2bCartItem.isSuccess = batchResult.isSuccess();
            
            // Test Error in Test Context
            if(Test.isRunningTest() && cartId == 'test_Err') {
                b2bCartItem.message = this.convertToMessage('Error Invoked');
            }
            else if (batchResult.isSuccess()) {
                ConnectApi.CartItem cartItemOutput = (ConnectApi.CartItem) batchResult.getResult();
                b2bCartItem.cartId = cartItemOutput.cartId;
                b2bCartItem.cartItemId = cartItemOutput.cartItemId;
                b2bCartItem.message = ITEM_SUCCESS;
            } 
            else {
                b2bCartItem.message = this.convertToMessage(batchResult.getErrorMessage());
            }
        }
    }

    /*****************************************************************************************************************************
    * Method Name      :     insertCartItemsBulk
    * Input            :     communityId Community Id
    * 				   :	 effectiveAccountId Account Id
    * 				   :	 cartId Cart Id
    * 				   :	 productIdTob2bCartItemMap Map of product IDs to cart items
    *  				   :	 cartItemLimit Maximum number of items allowed
    * Description      :     Adds cart items in batches when count exceeds 100, per ConnectApi limit.
    *****************************************************************************************************************************/
    public void insertCartItemsBulk(
        String communityId, 
        String effectiveAccountId, 
        String cartId, 
        Map<String, B2BCartItemDTO> productIdTob2bCartItemMap, 
        Integer cartItemLimit
    ) {
        Map<String, B2BCartItemDTO> productIdTob2bCartItemMapNew = new Map<String, B2BCartItemDTO>();
        Integer cartItems = [
            SELECT COUNT()
            FROM CartItem
            WHERE CartId =:cartId
        ];
        Integer totalCartItems = cartItems + productIdTob2bCartItemMap.size();
        
        // Enforce upper limit on cart items
        if (cartItems >= cartItemLimit) {
            throw new B2BException(ERROR_UPLOAD_LIMIT);
        }
        
        Map<String, B2BCartItemDTO> productIdTob2bCartItemMapPer = new Map<String, B2BCartItemDTO>();
        Integer count = 0;
        system.debug('productIdTob2bCartItemMap'+productIdTob2bCartItemMap);
        for (String key : productIdTob2bCartItemMap.keySet()) {
            count++;
            productIdTob2bCartItemMapPer.put(key, productIdTob2bCartItemMap.get(key));
            
            if (Math.mod(count, 100) == 0) {
                insertCartItems(communityId, effectiveAccountId, productIdTob2bCartItemMapPer, cartId);
                productIdTob2bCartItemMapNew.putAll(productIdTob2bCartItemMapPer);
                productIdTob2bCartItemMapPer = new Map<String, B2BCartItemDTO>();
            }
            
            if (count == productIdTob2bCartItemMap.size() && Math.mod(count, 100) != 0) {
                insertCartItems(communityId, effectiveAccountId, productIdTob2bCartItemMapPer, cartId);
                productIdTob2bCartItemMapNew.putAll(productIdTob2bCartItemMapPer);
            }
        }
        
        productIdTob2bCartItemMap = productIdTob2bCartItemMapNew;
        
    }
